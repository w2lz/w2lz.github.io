<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>30 | 答疑文章（二）：用动态的观点看加锁 | 一个 PHP 菜鸟的心路历程</title><meta name=author content="w2lz">
<meta name=description content="本文深入探讨了 InnoDB 的加锁规则，通过具体案例分析，动态解析了加锁过程。"><meta name=keywords content='MySQL 实战 45 讲,MySQL'><meta itemprop=name content="30 | 答疑文章（二）：用动态的观点看加锁"><meta itemprop=description content="本文深入探讨了 InnoDB 的加锁规则，通过具体案例分析，动态解析了加锁过程。"><meta itemprop=datePublished content="2025-02-23T22:59:14+08:00"><meta itemprop=dateModified content="2025-05-04T14:15:05+00:00"><meta itemprop=wordCount content="3565"><meta itemprop=image content="https://blog.yingnan.wang/images/apple-devices-preview.webp"><meta itemprop=keywords content="MySQL 实战 45 讲,MySQL"><meta property="og:url" content="https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/"><meta property="og:site_name" content="一个 PHP 菜鸟的心路历程"><meta property="og:title" content="30 | 答疑文章（二）：用动态的观点看加锁"><meta property="og:description" content="本文深入探讨了 InnoDB 的加锁规则，通过具体案例分析，动态解析了加锁过程。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-23T22:59:14+08:00"><meta property="article:modified_time" content="2025-05-04T14:15:05+00:00"><meta property="article:tag" content="MySQL 实战 45 讲"><meta property="article:tag" content="MySQL"><meta property="og:image" content="https://blog.yingnan.wang/images/apple-devices-preview.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.yingnan.wang/images/apple-devices-preview.webp"><meta name=twitter:title content="30 | 答疑文章（二）：用动态的观点看加锁"><meta name=twitter:description content="本文深入探讨了 InnoDB 的加锁规则，通过具体案例分析，动态解析了加锁过程。"><meta name=application-name content="一个 PHP 菜鸟的心路历程"><meta name=apple-mobile-web-app-title content="一个 PHP 菜鸟的心路历程"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical type=text/html href=https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/ title="30 | 答疑文章（二）：用动态的观点看加锁 | 一个 PHP 菜鸟的心路历程"><link rel=prev type=text/html href=https://blog.yingnan.wang/posts/29.%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%AF%E4%B8%8D%E6%98%AF%E5%87%BA%E9%97%AE%E9%A2%98%E4%BA%86/ title="29 | 如何判断一个数据库是不是出问题了？"><link rel=next type=text/html href=https://blog.yingnan.wang/posts/31.%E8%AF%AF%E5%88%A0%E6%95%B0%E6%8D%AE%E5%90%8E%E9%99%A4%E4%BA%86%E8%B7%91%E8%B7%AF%E8%BF%98%E8%83%BD%E6%80%8E%E4%B9%88%E5%8A%9E/ title="31 | 误删数据后除了跑路，还能怎么办？"><link rel=alternate type=text/markdown href=https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/index.md title="30 | 答疑文章（二）：用动态的观点看加锁 | 一个 PHP 菜鸟的心路历程"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://unpkg.com/@fortawesome/fontawesome-free@6.7.1/css/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.7.1/css/all.min.css></noscript><link rel=preload href=https://unpkg.com/animate.css@4.1.1/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"30 | 答疑文章（二）：用动态的观点看加锁","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.yingnan.wang\/posts\/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81\/"},"image":[{"@type":"ImageObject","url":"https:\/\/blog.yingnan.wang\/images\/apple-devices-preview.webp","width":2976,"height":1406}],"genre":"posts","keywords":"MySQL 实战 45 讲, MySQL","wordcount":3565,"url":"https:\/\/blog.yingnan.wang\/posts\/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81\/","datePublished":"2025-02-23T22:59:14+08:00","dateModified":"2025-05-04T14:15:05+00:00","license":"本站内容采用 CC BY-NC-SA 4.0 国际许可协议。","publisher":{"@type":"Organization","name":"w2lz","logo":"https:\/\/blog.yingnan.wang\/images\/avatar.jpg"},"author":{"@type":"Person","name":"w2lz"},"description":"本文深入探讨了 InnoDB 的加锁规则，通过具体案例分析，动态解析了加锁过程。"}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="一个 PHP 菜鸟的心路历程"><img class=logo src=/logo.webp alt="一个 PHP 菜鸟的心路历程" height=32 width=32><span class=header-title-text>一个 PHP 菜鸟的心路历程</span></a><span class=header-subtitle>王二愣子的博客</span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/archives/><i class="fa-solid fa-feather fa-fw fa-sm" aria-hidden=true></i> 文章</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/reward/><i class="fa-solid fa-hand-holding-dollar fa-fw fa-sm" aria-hidden=true></i> 赞赏</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comment-dots fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/index.xml title="通过 RSS 订阅"><i class="fa-solid fa-rss fa-fw fa-sm" aria-hidden=true></i> RSS</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-quote-left fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=https://umami.yingnan.wang/share/bKqBY46rBmekKzDf/blog.yingnan.wang rel="noopener noreferrer" target=_blank><i class="fa-solid fa-bowl-rice fa-fw fa-sm" aria-hidden=true></i> 网站统计</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li><li class="menu-item language-switch auto d-none" aria-hidden=true><span role=button aria-label=选择语言 title=选择语言><i class="fa-solid fa-language fa-fw" aria-hidden=true></i></span><ul class=sub-menu><li class="menu-item active" data-type=artificial><a href=/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/ data-lang=zh-CN class="menu-link text-secondary" title=简体中文><i class="fa-solid fa-person fa-fw fa-sm" aria-hidden=true></i> 简体中文</a></li><li class=menu-item-divider aria-hidden=true></li><li class=menu-item data-type=machine><a data-lang=chinese_simplified class=menu-link title=简体中文><i class="fa-solid fa-robot fa-fw fa-sm" aria-hidden=true></i> 简体中文</a></li><li class=menu-item data-type=machine><a data-lang=chinese_traditional class=menu-link title=繁體中文><i class="fa-solid fa-robot fa-fw fa-sm" aria-hidden=true></i> 繁體中文</a></li></ul></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="一个 PHP 菜鸟的心路历程"><img class=logo src=/logo.webp alt="一个 PHP 菜鸟的心路历程" height=26 width=26><span class=header-title-text>一个 PHP 菜鸟的心路历程</span></a><span class=header-subtitle>王二愣子的博客</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/archives/><i class="fa-solid fa-feather fa-fw fa-sm" aria-hidden=true></i> 文章</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/reward/><i class="fa-solid fa-hand-holding-dollar fa-fw fa-sm" aria-hidden=true></i> 赞赏</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comment-dots fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-quote-left fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=https://umami.yingnan.wang/share/bKqBY46rBmekKzDf/blog.yingnan.wang rel="noopener noreferrer" target=_blank><i class="fa-solid fa-bowl-rice fa-fw fa-sm" aria-hidden=true></i> 网站统计</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/w2lz/ rel="noopener noreferrer" target=_blank><i class="fa-brands fa-github fa-lg fa-fw fa-sm" aria-hidden=true></i> 关注 Follow</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span><span id=translate class="menu-system-item language-switch auto d-none" aria-hidden=true>
<span role=button aria-label=选择语言 title=选择语言 data-current=简体中文>简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item data-separator=/><a href=/posts/ title=Posts>文章</a></li><li class="breadcrumb-item active" data-separator=/ aria-current=page>30 | 答疑文章（二）：用动态的观点看加锁</li></ol></nav><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集><div class="details related-details open"><div class="details-summary related-summary"><i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden=true></i>
<span class=related-title>相关内容</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content related-content"><ul class=related-list><li class=related-item><a href=/posts/28.%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%9C%89%E5%93%AA%E4%BA%9B%E5%9D%91/ title="28 | 读写分离有哪些坑？">28 | 读写分离有哪些坑？</a></li><li class=related-item><a href=/posts/27.%E4%B8%BB%E5%BA%93%E5%87%BA%E9%97%AE%E9%A2%98%E4%BA%86%E4%BB%8E%E5%BA%93%E6%80%8E%E4%B9%88%E5%8A%9E/ title="27 | 主库出问题了，从库怎么办？">27 | 主库出问题了，从库怎么办？</a></li><li class=related-item><a href=/posts/26.%E5%A4%87%E5%BA%93%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%BB%B6%E8%BF%9F%E5%A5%BD%E5%87%A0%E4%B8%AA%E5%B0%8F%E6%97%B6/ title="26 | 备库为什么会延迟好几个小时？">26 | 备库为什么会延迟好几个小时？</a></li><li class=related-item><a href=/posts/25.mysql%E6%98%AF%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84/ title="25 | MySQL 是怎么保证高可用的？">25 | MySQL 是怎么保证高可用的？</a></li><li class=related-item><a href=/posts/24.mysql%E6%98%AF%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E4%B8%BB%E5%A4%87%E4%B8%80%E8%87%B4%E7%9A%84/ title="24 | MySQL 是怎么保证主备一致的？">24 | MySQL 是怎么保证主备一致的？</a></li></ul></div></div><div class=aside-custom><img src=/images/wxmp.webp alt=微信公众号 width=100%></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>30 | 答疑文章（二）：用动态的观点看加锁</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/w2lz title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src='https://gravatar.loli.net/avatar/72786a26cc6c5dc19ea50e6408879033?s=32&d=mp' alt=w2lz height=16 width=16>&nbsp;w2lz</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/mysql-%E5%AE%9E%E6%88%98-45-%E8%AE%B2/ class=post-category title="分类 - MySQL 实战 45 讲"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> MySQL 实战 45 讲</a>&ensp;<a href=/categories/mysql/ class=post-category title="分类 - MySQL"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> MySQL</a></span></div><div class=post-meta-line><span title="发布于 2025-02-23 22:59:14"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2025-02-23>2025-02-23</time></span>&nbsp;<span title="更新于 2025-05-04 14:15:05"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2025-05-04>2025-05-04</time></span>&nbsp;<span title="3565 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3600 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 8 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="30 | 答疑文章（二）：用动态的观点看加锁"><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#不等号条件里的等值查询>不等号条件里的等值查询</a></li><li><a href=#等值查询的过程>等值查询的过程</a></li><li><a href=#怎么看死锁>怎么看死锁？</a></li><li><a href=#怎么看锁等待>怎么看锁等待？</a></li><li><a href=#update-的例子>update 的例子</a></li><li><a href=#问题>问题</a></li></ol></nav></div></div><div class=content id=content data-end-flag="「本文完，更多内容汇总在我的 GitHub，持续更新，求关注、求 star、求订阅！」"><div class="details admonition quote open"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-quote-right" aria-hidden=true></i>摘要<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>本文深入探讨了 InnoDB 的加锁规则，通过具体案例分析，动态解析了加锁过程。文章首先回顾了加锁规则，包括 next-key lock 作为基本单位、访问对象才会加锁等内容。随后，通过查询案例分析了不等号条件中的等值查询和并发执行可能出现的死锁问题。</div></div></div><p>复习一下加锁规则。这个规则中，包含了两个“原则”、两个“优化”和一个“bug”：</p><ul><li><p>原则 1：加锁的基本单位是 next-key lock，next-key lock 是前开后闭区间。</p></li><li><p>原则 2：查找过程中访问到的对象才会加锁。</p></li><li><p>优化 1：索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁。</p></li><li><p>优化 2：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁。</p></li><li><p>一个 bug：唯一索引上的范围查询会访问到不满足条件的第一个值为止。</p></li></ul><p>接下来的讨论基于下面这个表 t：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>t</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=k>c</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>d</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>KEY</span><span class=w> </span><span class=o>`</span><span class=k>c</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=k>c</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>),(</span><span class=mi>5</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>5</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>10</span><span class=p>,</span><span class=mi>10</span><span class=p>),(</span><span class=mi>15</span><span class=p>,</span><span class=mi>15</span><span class=p>,</span><span class=mi>15</span><span class=p>),(</span><span class=mi>20</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>20</span><span class=p>),(</span><span class=mi>25</span><span class=p>,</span><span class=mi>25</span><span class=p>,</span><span class=mi>25</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=不等号条件里的等值查询><span>1 不等号条件里的等值查询</span>
<a href=#%e4%b8%8d%e7%ad%89%e5%8f%b7%e6%9d%a1%e4%bb%b6%e9%87%8c%e7%9a%84%e7%ad%89%e5%80%bc%e6%9f%a5%e8%af%a2 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>先来一起来看下这个例子，分析一下这条查询语句的加锁范围：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>&gt;</span><span class=mi>9</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>id</span><span class=o>&lt;</span><span class=mi>12</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>利用上面的加锁规则，我们知道这个语句的加锁范围是主键索引上的 (0,5]、(5,10] 和 (10, 15)。也就是说，id=15 这一行，并没有被加上行锁。为什么呢？</p><p>我们说加锁单位是 next-key lock，都是前开后闭区间，但是这里用到了优化 2，即索引上的等值查询，向右遍历的时候 id=15 不满足条件，所以 next-key lock 退化为了间隙锁 (10, 15)。</p><p>但是，查询语句中 where 条件是大于号和小于号，这里的“等值查询”又是从哪里来的呢？要知道，加锁动作是发生在语句执行过程中的，所以分析加锁行为的时候，要从索引上的数据结构开始。这里再把这个过程拆解一下。如下图所示，是这个表的索引 id 的示意图。</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/ac1aa07860c565b907b32c5f75c4f2bb.webp alt="索引 id 示意图"></p><ol><li><p>首先这个查询语句的语义是 order by id desc，要拿到满足条件的所有行，优化器必须先找到“第一个 id&lt;12 的值”。</p></li><li><p>这个过程是通过索引树的搜索过程得到的，在引擎内部，其实是要找到 id=12 的这个值，只是最终没找到，但找到了 (10,15) 这个间隙。</p></li><li><p>然后向左遍历，在遍历过程中，就不是等值查询了，会扫描到 id=5 这一行，所以会加一个 next-key lock (0,5]。</p></li></ol><p>也就是说，在执行过程中，通过树搜索的方式定位记录的时候，用的是“等值查询”的方法。</p><h2 class=heading-element id=等值查询的过程><span>2 等值查询的过程</span>
<a href=#%e7%ad%89%e5%80%bc%e6%9f%a5%e8%af%a2%e7%9a%84%e8%bf%87%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>与上面这个例子对应的，下面这个语句的加锁范围是什么？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>in</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>share</span><span class=w> </span><span class=k>mode</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>这条查询语句里用的是 in，先来看这条语句的 explain 结果。</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/8a089159c82c1458b26e2756583347b3.webp alt="in 语句的 explain 结果"></p><p>可以看到，这条 in 语句使用了索引 c 并且 rows=3，说明这三个值都是通过 B+ 树搜索定位的。</p><p>在查找 c=5 的时候，先锁住了 (0,5]。但是因为 c 不是唯一索引，为了确认还有没有别的记录 c=5，就要向右遍历，找到 c=10 才确认没有了，这个过程满足优化 2，所以加了间隙锁 (5,10)。</p><p>同样的，执行 c=10 这个逻辑的时候，加锁的范围是 (5,10] 和 (10,15)；执行 c=20 这个逻辑的时候，加锁的范围是 (15,20] 和 (20,25)。</p><p>通过这个分析，可以知道，这条语句在索引 c 上加的三个记录锁的顺序是：先加 c=5 的记录锁，再加 c=10 的记录锁，最后加 c=20 的记录锁。</p><p>这个加锁范围，不就是从 (5,25) 中去掉 c=15 的行锁吗？为什么这么麻烦地分段说呢？因为要强调这个过程：这些锁是“在执行过程中一个一个加的”，而不是一次性加上去的。</p><p>理解了这个加锁过程之后，就可以来分析下面例子中的死锁问题了。如果同时有另外一个语句，是这么写的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>in</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>此时的加锁范围，又是什么呢？</p><p>现在都知道间隙锁是不互锁的，但是这两条语句都会在索引 c 上的 c=5、10、20 这三行记录上加记录锁。</p><p>这里需要注意一下，由于语句里面是 order by c desc，这三个记录锁的加锁顺序，是先锁 c=20，然后 c=10，最后是 c=5。</p><p>也就是说，这两条语句要加锁相同的资源，但是加锁顺序相反。当这两条语句并发执行的时候，就可能出现死锁。关于死锁的信息，MySQL 只保留了最后一个死锁的现场，但这个现场还是不完备的。</p><h2 class=heading-element id=怎么看死锁><span>3 怎么看死锁？</span>
<a href=#%e6%80%8e%e4%b9%88%e7%9c%8b%e6%ad%bb%e9%94%81 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>下图是在出现死锁后，执行 show engine innodb status 命令得到的部分输出。这个命令会输出很多信息，有一节 LATESTDETECTED DEADLOCK，就是记录的最后一次死锁信息。</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/a7dccb91bc17d12746703eb194775cf6.webp alt=死锁现场></p><p>来看看这图中的几个关键信息。</p><ol><li><p>这个结果分成三部分：</p><ul><li><p>(1) TRANSACTION，是第一个事务的信息；</p></li><li><p>(2) TRANSACTION，是第二个事务的信息；</p></li><li><p>WE ROLL BACK TRANSACTION (1)，是最终的处理结果，表示回滚了第一个事务。</p></li></ul></li><li><p>第一个事务的信息中：</p><ul><li><p>WAITING FOR THIS LOCK TO BE GRANTED，表示的是这个事务在等待的锁信息；</p></li><li><p>index c of table <code>test</code>.<code>t</code>，说明在等的是表 t 的索引 c 上面的锁；</p></li><li><p>lock mode S waiting 表示这个语句要自己加一个读锁，当前的状态是等待中；</p></li><li><p>Record lock 说明这是一个记录锁；</p></li><li><p>n_fields 2 表示这个记录是两列，也就是字段 c 和主键字段 id；</p></li><li><p>0: len 4; hex 0000000a; asc ;; 是第一个字段，也就是 c。值是十六进制 a，也就是 10；</p></li><li><p>1: len 4; hex 0000000a; asc ;; 是第二个字段，也就是主键 id，值也是 10；</p></li><li><p>这两行里面的 asc 表示的是，接下来要打印出值里面的“可打印字符”，但 10 不是可打印字符，因此就显示空格。</p></li><li><p>第一个事务信息就只显示出了等锁的状态，在等待 (c=10,id=10) 这一行的锁。</p></li><li><p>当然你是知道的，既然出现死锁了，就表示这个事务也占有别的锁，但是没有显示出来。别着急，从第二个事务的信息中推导出来。</p></li></ul></li><li><p>第二个事务显示的信息要多一些：</p><ul><li><p>“HOLDS THE LOCK(S)”用来显示这个事务持有哪些锁；</p></li><li><p>index c of table <code>test</code>.<code>t</code> 表示锁是在表 t 的索引 c 上；</p></li><li><p>hex 0000000a 和 hex 00000014 表示这个事务持有 c=10 和 c=20 这两个记录锁；</p></li><li><p>WAITING FOR THIS LOCK TO BE GRANTED，表示在等 (c=5,id=5) 这个记录锁。</p></li></ul></li></ol><p>从上面这些信息中，就可以知道：</p><ol><li><p>“lock in share mode”的这条语句，持有 c=5 的记录锁，在等 c=10 的锁；</p></li><li><p>“for update”这个语句，持有 c=20 和 c=10 的记录锁，在等 c=5 的记录锁。</p></li></ol><p>因此导致了死锁。这里可以得到两个结论：</p><ol><li><p>由于锁是一个个加的，要避免死锁，对同一组资源，要按照尽量相同的顺序访问；</p></li><li><p>在发生死锁的时刻，for update 这条语句占有的资源更多，回滚成本更大，所以 InnoDB 选择了回滚成本更小的 lock in share mode 语句，来回滚。</p></li></ol><h2 class=heading-element id=怎么看锁等待><span>4 怎么看锁等待？</span>
<a href=#%e6%80%8e%e4%b9%88%e7%9c%8b%e9%94%81%e7%ad%89%e5%be%85 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>看完死锁，再来看一个锁等待的例子。</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/af3602b81aeb49e33577ba372d220a75.webp alt="delete 导致间隙变化"></p><p>可以看到，由于 session A 并没有锁住 c=10 这个记录，所以 session B 删除 id=10 这一行是可以的。但是之后，session B 再想 insert id=10 这一行回去就不行了。</p><p>现在来看一下此时 show engine innodb status 的结果，看看能不有一些提示。锁信息是在这个命令输出结果的 TRANSACTIONS 这一节。可以在文稿中看到这张图片。</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/c3744fb7b61df2a5b45b8eb1f2a853a6.webp alt=锁等待信息></p><p>来看几个关键信息。</p><ol><li><p>index PRIMARY of table <code>test</code>.<code>t</code> ，表示这个语句被锁住是因为表 t 主键上的某个锁。</p></li><li><p>lock_mode X locks gap before rec insert intention waiting 这里有几个信息：</p><ul><li><p>insert intention 表示当前线程准备插入一个记录，这是一个插入意向锁。为了便于理解，可以认为它就是这个插入动作本身。</p></li><li><p>gap before rec 表示这是一个间隙锁，而不是记录锁。</p></li></ul></li><li><p>那么这个 gap 是在哪个记录之前的呢？接下来的 0~4 这 5 行的内容就是这个记录的信息。</p></li><li><p>n_fields 5 也表示了，这一个记录有 5 列：</p><ul><li><p>0: len 4; hex 0000000f; asc ;; 第一列是主键 id 字段，十六进制 f 就是 id=15。所以，这时我们就知道了，这个间隙就是 id=15 之前的，因为 id=10 已经不存在了，它表示的就是 (5,15)。</p></li><li><p>1: len 6; hex 000000000513; asc ;; 第二列是长度为 6 字节的事务 id，表示最后修改这一行的是 trx id 为 1299 的事务。</p></li><li><p>2: len 7; hex b0000001250134; asc % 4;; 第三列长度为 7 字节的回滚段信息。可以看到，这里的 acs 后面有显示内容 (% 和 4)，这是因为刚好这个字节是可打印字符。</p></li><li><p>后面两列是 c 和 d 的值，都是 15。</p></li></ul></li></ol><p>因此就知道了，由于 delete 操作把 id=10 这一行删掉了，原来的两个间隙 (5,10)、(10,15）变成了一个 (5,15)。说到这里，可以联合起来再思考一下这两个现象之间的关联：</p><ol><li><p>session A 执行完 select 语句后，什么都没做，但它加锁的范围突然“变大”了；</p></li><li><p>当执行 select * from t where c>=15 and c&lt;=20 order by c desc lock in share mode; 向左扫描到 c=10 的时候，要把 (5, 10] 锁起来。</p></li></ol><p>也就是说，所谓“间隙”，其实根本就是由“这个间隙右边的那个记录”定义的。</p><h2 class=heading-element id=update-的例子><span>5 update 的例子</span>
<a href=#update-%e7%9a%84%e4%be%8b%e5%ad%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>看过了 insert 和 delete 的加锁例子，再来看一个 update 语句的案例。</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/61c1ceea7b59201649c2514c9db864a7.webp alt="update 的例子"></p><p>可以自己分析一下，session A 的加锁范围是索引 c 上的 (5,10]、(10,15]、(15,20]、(20,25] 和 (25,supremum]。</p><blockquote><p>注意：根据 c>5 查到的第一个记录是 c=10，因此不会加 (0,5] 这个 next-key lock。</p></blockquote><p>之后 session B 的第一个 update 语句，要把 c=5 改成 c=1，可以理解为两步：</p><ol><li><p>插入 (c=1, id=5) 这个记录；</p></li><li><p>删除 (c=5, id=5) 这个记录。</p></li></ol><p>按照前面说的，索引 c 上 (5,10) 间隙是由这个间隙右边的记录，也就是 c=10 定义的。所以通过这个操作，session A 的加锁范围变成了下图所示的样子：</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/d2f6a0c46dd8d12f6a90dacc466d53e9.webp alt="session B 修改后，session A 的加锁范围"></p><p>好，接下来 session B 要执行 update t set c = 5 where c = 1 这个语句了，一样地可以拆成两步：</p><ol><li><p>插入 (c=5, id=5) 这个记录；</p></li><li><p>删除 (c=1, id=5) 这个记录。</p></li></ol><p>第一步试图在已经加了间隙锁的 (1,10) 中插入数据，所以就被堵住了。</p><h2 class=heading-element id=问题><span>6 问题</span>
<a href=#%e9%97%ae%e9%a2%98 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>问：所谓“间隙”，其实根本就是由“这个间隙右边的那个记录”定义的。那么，一个空表有间隙吗？这个间隙是由谁定义的？怎么验证这个结论呢？</p><p>答：一个空表就只有一个间隙。比如，在空表上执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>&gt;</span><span class=mi>1</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>这个查询语句加锁的范围就是 next-key lock (-∞, supremum]。验证方法的话，可以使用下面的操作序列。可以在下图中看到显示的结果。</p><p><img loading=lazy src=https://file.yingnan.wang/mysql/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/531b6556ffc82c6b02f9a010a3ceb09f.webp alt="show engine innodb status 部分结果"></p></div><hr class=awesome-hr><h2 id=see-also>相关内容</h2><ul><li><a href=/posts/28.%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%9C%89%E5%93%AA%E4%BA%9B%E5%9D%91/ title="28 | 读写分离有哪些坑？">28 | 读写分离有哪些坑？</a></li><li><a href=/posts/27.%E4%B8%BB%E5%BA%93%E5%87%BA%E9%97%AE%E9%A2%98%E4%BA%86%E4%BB%8E%E5%BA%93%E6%80%8E%E4%B9%88%E5%8A%9E/ title="27 | 主库出问题了，从库怎么办？">27 | 主库出问题了，从库怎么办？</a></li><li><a href=/posts/26.%E5%A4%87%E5%BA%93%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%BB%B6%E8%BF%9F%E5%A5%BD%E5%87%A0%E4%B8%AA%E5%B0%8F%E6%97%B6/ title="26 | 备库为什么会延迟好几个小时？">26 | 备库为什么会延迟好几个小时？</a></li><li><a href=/posts/25.mysql%E6%98%AF%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84/ title="25 | MySQL 是怎么保证高可用的？">25 | MySQL 是怎么保证高可用的？</a></li><li><a href=/posts/24.mysql%E6%98%AF%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E4%B8%BB%E5%A4%87%E4%B8%80%E8%87%B4%E7%9A%84/ title="24 | MySQL 是怎么保证主备一致的？">24 | MySQL 是怎么保证主备一致的？</a></li></ul><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=fixed><div><img src=/images/alipay.jpg alt="w2lz 支付宝"><span data-animation>支付宝</span></div><div><img src=/images/wechatpay.jpg alt="w2lz 微信"><span data-animation>微信</span></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-05-04 14:15:05">更新于 2025-05-04&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href="https://github.com/w2lz/hugo-blog/blob/docs/content/posts/_backend/_sql/MySQL%e5%ae%9e%e6%88%9845%e8%ae%b2/30.%e7%ad%94%e7%96%91%e6%96%87%e7%ab%a0%ef%bc%88%e4%ba%8c%ef%bc%89:%e7%94%a8%e5%8a%a8%e6%80%81%e7%9a%84%e8%a7%82%e7%82%b9%e7%9c%8b%e5%8a%a0%e9%94%81.md?plain=1" title=查看源码 target=_blank rel="external nofollow noopener noreferrer" class=link-to-source>查看源码</a></span><span><a href=https://github.com/w2lz/hugo-blog/edit/docs/content/posts/_backend/_sql/MySQL%e5%ae%9e%e6%88%9845%e8%ae%b2/30.%e7%ad%94%e7%96%91%e6%96%87%e7%ab%a0%ef%bc%88%e4%ba%8c%ef%bc%89:%e7%94%a8%e5%8a%a8%e6%80%81%e7%9a%84%e8%a7%82%e7%82%b9%e7%9c%8b%e5%8a%a0%e9%94%81.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span><span><a href="https://github.com/w2lz/hugo-blog/issues/new?title=[BUG]%2030+%7C+%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7c30+%7C+%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81%7c%0A%7cURL%7chttps://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/%7c%0A%7cFilename%7chttps://github.com/w2lz/hugo-blog/blob/docs/content/posts/_backend/_sql/MySQL%e5%ae%9e%e6%88%9845%e8%ae%b2/30.%e7%ad%94%e7%96%91%e6%96%87%e7%ab%a0%ef%bc%88%e4%ba%8c%ef%bc%89:%e7%94%a8%e5%8a%a8%e6%80%81%e7%9a%84%e8%a7%82%e7%82%b9%e7%9c%8b%e5%8a%a0%e9%94%81.md?plain=1%7c" title=报告问题 target=_blank rel="external nofollow noopener noreferrer" class=link-to-report>报告问题</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/ data-title="30 | 答疑文章（二）：用动态的观点看加锁" data-hashtags="MySQL 实战 45 讲,MySQL"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/ data-hashtag="MySQL 实战 45 讲"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/ data-title="30 | 答疑文章（二）：用动态的观点看加锁"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://blog.yingnan.wang/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/ data-title="30 | 答疑文章（二）：用动态的观点看加锁"><i data-svg-src=https://unpkg.com/simple-icons@9.19.0/icons/baidu.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/mysql-%E5%AE%9E%E6%88%98-45-%E8%AE%B2/ class=post-tag title="标签 - MySQL 实战 45 讲">MySQL 实战 45 讲</a><a href=/tags/mysql/ class=post-tag title="标签 - MySQL">MySQL</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/29.%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%AF%E4%B8%8D%E6%98%AF%E5%87%BA%E9%97%AE%E9%A2%98%E4%BA%86/ class=post-nav-item rel=prev title="29 | 如何判断一个数据库是不是出问题了？"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>29 | 如何判断一个数据库是不是出问题了？</a><a href=/posts/31.%E8%AF%AF%E5%88%A0%E6%95%B0%E6%8D%AE%E5%90%8E%E9%99%A4%E4%BA%86%E8%B7%91%E8%B7%AF%E8%BF%98%E8%83%BD%E6%80%8E%E4%B9%88%E5%8A%9E/ class=post-nav-item rel=next title="31 | 误删数据后除了跑路，还能怎么办？">31 | 误删数据后除了跑路，还能怎么办？<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer__after><div class="d-none-desktop text-center"><img src=/images/wxmp.webp alt=微信公众号 width=70%></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=w2lz/hugo-blog data-repo-id=R_kgDONQidkg data-category=General data-category-id=DIC_kwDONQidks4CkV4r data-mapping=title data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.147.1"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2024 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/w2lz target=_blank rel="external nofollow noopener noreferrer">w2lz</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics order-3"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/w2lz/hugo-blog title="在 GitHub 上查看源码，订阅请点 Watch~" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#8581dd;--bg-progress-dark:#fff></div><div class=wechat-box><div class=wechat-menu><div class=wechat-hover><div class=wechat-description>微信扫一扫，订阅本博客</div></div></div></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.css><link rel=stylesheet href=https://unpkg.com/pace-js@1.2.4/themes/blue/pace-theme-minimal.css><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src=https://unpkg.com/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://unpkg.com/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js defer></script><script src=https://unpkg.com/instant.page@5.2.0/instantpage.js async defer type=module></script><script src=https://unpkg.com/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.js defer></script><script src=https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js defer></script><script src=https://unpkg.com/cell-watermark@1.0.3/src/watermark.min.js defer></script><script src=https://vercount.one/js async defer></script><script src=https://unpkg.com/pace-js@1.2.4/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark_dimmed",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"QAZSU1QVH7",algoliaIndex:"search",algoliaSearchKey:"ffd23519a321c724dbe6bacd82d9ffd2",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2024-11-17T12:00:00+08:00",version:"v0.3.20",watermark:{colspacing:30,content:'<img style="height: 0.85rem;" src="/logo.webp" alt="logo" /> 王二愣子',enable:!0,fontfamily:"MMT_LRH,沐目体",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/flyfish.min.js defer></script><script src=/lib/translate.min.js defer></script><script>window.ATConfig={hugoLangCodes:["zh-CN"],hugoLangMap:{"zh-CN":"/posts/30.%E7%AD%94%E7%96%91%E6%96%87%E7%AB%A0%E4%BA%8C%E7%94%A8%E5%8A%A8%E6%80%81%E7%9A%84%E8%A7%82%E7%82%B9%E7%9C%8B%E5%8A%A0%E9%94%81/"}}</script><script src=/js/translate.fixit.min.js defer></script><script src=/js/custom.min.js defer></script><script async defer data-website-id=2b780ddc-ae5f-480d-9edb-58b4ab0eacf8 src=https://umami.yingnan.wang/script.js></script></body></html>